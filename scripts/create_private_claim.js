const user1 = {
  email: "moo@ookbee.com",
  firstname: "OOKBEE U Co., LTD",
  lastname: "",
  phone_number: "+66818268208",
  claimData: {
    0: {
      amount: 6818181,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1536051600000 // 1528275600000 + ( days * 86400000 )
    },
    1: {
      amount: 15909089,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1574931600000 // 1528275600000 + ( days * 86400000 )
    },
    2: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user2 = {
  email: "morikawa@cchan.tv",
  firstname: "Akira Morikawa",
  lastname: "",
  phone_number: "+819070122531",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user3 = {
  email: "boydtuiko@gmail.com",
  firstname: "Boyd Kosiyabong",
  lastname: "",
  phone_number: "+66818466853",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user4 = {
  email: "min.kim@daylifg.com",
  firstname: "Min Kim",
  lastname: "",
  phone_number: "+15107899496",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user5 = {
  email: "phawit.chi@gmmgrammy.com",
  firstname: "Phawit Chitrakorn",
  lastname: "",
  phone_number: "+66897779587",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user6 = {
  email: "thakorn.piyapan@krungsri.com",
  firstname: "Thakorn Piyapan",
  lastname: "",
  phone_number: "+66819127660",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user7 = {
  email: "vincent.ha@gushcloud.com",
  firstname: "Vincent Ha",
  lastname: "",
  phone_number: "+6597464415",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user8 = {
  email: "jirath@ignite.co.th",
  firstname: "Jirath Pavaravadhana",
  lastname: "",
  phone_number: "+66898977887",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user9 = {
  email: "siwat@siwat.com",
  firstname: "Siwat",
  lastname: "",
  phone_number: "+66816101975",
  claimData: {
    0: {
      amount: 240000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const user10 = {
  email: "richardhoyun@hotmail.com",
  firstname: "Richard",
  lastname: "",
  phone_number: "+821052305599",
  claimData: {
    0: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    },
    1: {
      amount: 20,
      type: "free",
      valid_after: 1528275600000 // 1528275600000 + ( days * 86400000 )
    }
  },
  recheck: true
};

const updateUser1 = {
  email: "bhurit@boonrawd.co.th",
  updateClaimData: {
    5: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser2 = {
  email: "swc4007@gmail.com",
  updateClaimData: {
    4: {
      amount: 600000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser3 = {
  email: "jonlee@yellomobile.com",
  updateClaimData: {
    4: {
      amount: 900000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser4 = {
  email: "sslee@yellomobile.com",
  updateClaimData: {
    5: {
      amount: 900000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser5 = {
  email: "khailee@500.co",
  updateClaimData: {
    5: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser6 = {
  email: "tulyanond@gmail.com",
  updateClaimData: {
    8: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser7 = {
  email: "kratingp@gmail.com",
  updateClaimData: {
    5: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser8 = {
  email: "ceo@mfec.co.th",
  updateClaimData: {
    5: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser9 = {
  email: "thanahappymail@gmail.com",
  updateClaimData: {
    4: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser10 = {
  email: "thanapong.na@gmail.com",
  updateClaimData: {
    4: {
      amount: 480000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const updateUser11 = {
  email: "imchoi@gmail.com",
  updateClaimData: {
    4: {
      amount: 600000,
      bonus: null,
      bonus_six: null,
      normal_six: null,
      type: "Type AV",
      valid_after: 1559811600000
    }
  },
  recheck: true
};

const admin = require("firebase-admin");
const uuid = require("uuid/v5");
const configPath = __dirname + "/config/config.json";
const serviceAccount = require(configPath);

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://sixdashboard.firebaseio.com"
});
const db = admin.firestore();

async function asyncForEach(array, callback) {
  for (let index = 0; index < array.length; index++) {
    await callback(array[index], index, array);
  }
}

async function generateUser(user) {
  console.log("----> Generating user : " + user.email);
  const uid = await getUIDByEmail(user.email);
  if (uid) {
    console.log(`email ${user.email} already exists.`);
    return true;
  }
  let newUid = `pri-${uuid(user.email, uuid.URL)}`;
  let newUser = {
    uid: newUid,
    email: user.email.trim(),
    emailVerified: true,
    password: Math.random()
      .toString(36)
      .slice(-8),
    displayName: `${user.firstname} ${user.lastname}`,
    disabled: false
  };

  await admin
    .auth()
    .createUser(newUser)
    .then(function(userRecord) {
      console.log("Successfully created new user:", userRecord.uid, user.email);
      user.uid = userRecord.uid;
      return userRecord;
    })
    .then(userRecord => {
      let setData = {
        uid: newUid,
        email: user.email.trim(),
        registration_time: new Date().getTime(),
        private_user: true,
        first_name: user.firstname,
        last_name: user.lastname,
        is_redeem_account: false,
        redeem_code: Math.random()
          .toString(36)
          .replace(/[^a-z0-9]+/g, "")
          .toUpperCase()
      };
      if (
        user.phone_number !== undefined &&
        user.phone_number !== "" &&
        user.phone_number !== null
      ) {
        setData.phone_number = user.phone_number;
        //setData.phone_verified = true
      }
      return admin
        .firestore()
        .collection("users")
        .doc(newUid)
        .set(setData, { merge: true })
        .then(() => {
          return userRecord;
        })
        .catch(() => {
          return userRecord;
        });
    })
    .catch(function(error) {
      console.log("Error creating new user:", error);
      return error.message;
    });
  await insertUser(newUid);
  return await asyncForEach(Object.keys(user.claimData), async key => {
    const claimData = user.claimData[key];
    return await insertClaimPeriods(key, newUid, claimData);
  });
}

async function getUIDByEmail(email) {
  return admin
    .auth()
    .getUserByEmail(email)
    .then(userRecord => userRecord.uid)
    .catch(() => false);
}

/**
 * insert user to uid in users_claim collection
 */
async function insertUser(uid) {
  // insert user
  const insertUserData = {
    public_key: "",
    sent_xlm: false,
    trustline: false
  };

  return db
    .collection("users_claim")
    .doc(uid)
    .set(insertUserData);
}

/**
 * insert claim period
 */
async function insertClaimPeriods(periodId, uid, claimData) {
  return db
    .collection("users_claim")
    .doc(uid)
    .collection("claim_period")
    .doc(periodId)
    .set(claimData);
}

/**
 * update exists user
 */
async function updateExistUser(user) {
  console.log("----> Updating user : " + user.email);
  const uid = await getUIDByEmail(user.email);
  if (!!!uid) {
    console.log(`email ${user.email} is not exists.`);
    return true;
  }
  return await asyncForEach(Object.keys(user.updateClaimData), async key => {
    const claimData = user.updateClaimData[key];
    return await insertClaimPeriods(key, uid, claimData);
  });
}

const start = async () => {
  console.log("======== STARTING");
  console.log("===== START GENERATE FUNCTIONING");
  await generateUser(user1);
  await generateUser(user2);
  await generateUser(user3);
  await generateUser(user4);
  await generateUser(user5);
  await generateUser(user6);
  await generateUser(user7);
  await generateUser(user8);
  await generateUser(user9);
  await generateUser(user10);
  console.log("===== DONE GENERATE FUNCTIONING");
  console.log("===== START UPDATE FUNCTIONING");
  await updateExistUser(updateUser1);
  await updateExistUser(updateUser2);
  await updateExistUser(updateUser3);
  await updateExistUser(updateUser4);
  await updateExistUser(updateUser5);
  await updateExistUser(updateUser6);
  await updateExistUser(updateUser7);
  await updateExistUser(updateUser8);
  await updateExistUser(updateUser9);
  await updateExistUser(updateUser10);
  await updateExistUser(updateUser11);
  console.log("===== DONE UPDATE FUNCTIONING");
  console.log("======== DONE");
  process.exit(0);
  return true;
};

start();
